{% extends 'base.html' %}

{% block content %}
<h1>Top 100 Price Changes</h1>

<!-- In Stock Toggle Button -->
<button class="toggle-button" id="toggleInStock" onclick="toggleInStock()">Show In Stock Only</button>

<div class="product-grid" id="product-grid">
    {% for product in products %}
        {% include '_product.html' %}
    {% endfor %}
</div>

<!-- Loading Spinner -->
<div id="loading" style="display: none;">
    <p>Loading more products...</p>
</div>

<!-- Scroll to Top Button -->
<button class="scroll-top-btn" id="scrollTopBtn" onclick="scrollToTop()">▲ Go to Top</button>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
	document.addEventListener('DOMContentLoaded', function() {
	    let currentPage = 1;
	    const maxProducts = 100;
	    const productsPerPage = 20;
	    let isInStockOnly = false;  // Declare the in-stock filter flag

	    // Function to load products with optional in-stock filtering
	    function loadMoreProducts() {
	        if (currentPage * productsPerPage >= maxProducts) return Promise.resolve(); // Stop if max products reached
	        currentPage += 1;

	        return fetch(`/top_price_changes?page=${currentPage}&in_stock=${isInStockOnly ? 1 : 0}`, {
	            headers: { 'X-Requested-With': 'XMLHttpRequest' }
	        })
	        .then(response => response.json())
	        .then(data => {
	            const productGrid = document.getElementById('product-grid');
	            if (!productGrid) {
	                console.error("productGrid element not found.");
	                return;
	            }

	            data.forEach(product => {
	                const productDiv = document.createElement('div');
	                productDiv.classList.add('product');
	                productDiv.setAttribute('data-stock-status', product.stock_status);

	                // Ensure the title has an anchor link to the product detail page
	                productDiv.innerHTML = `
	                    <img src="${product.image_url}" alt="${product.title}">
	                    <h3><a href="/product/${product.asin}">${product.title}</a></h3>
	                    <p><strong>Price:</strong> $${product.price}</p>
	                    <p><strong>Last Price Change:</strong> $${product.last_pricechange} (${product.last_pricechange_percent}%)</p>
	                    <p><strong>Stars:</strong> ${product.stars} ★</p>
	                    <p><strong>Status:</strong> ${product.stock_status === 'In Stock' ? 'In Stock' : 'Out of Stock'}</p>
	                    <div class="product-button-container">
	                        <a href="${product.product_link}" target="_blank">View on Amazon</a>
	                    </div>`;
	                productGrid.appendChild(productDiv);
	            });
	        })
	        .catch(error => {
	            console.error("Error fetching more products:", error);
	        });
	    }

	    // Attach infinite scroll function
	    attachInfiniteScroll(loadMoreProducts);

	    // Toggle In Stock Filter
	    const toggleButton = document.getElementById('toggleInStock');
	    toggleButton.addEventListener('click', function() {
	        isInStockOnly = !isInStockOnly;
	        toggleButton.textContent = isInStockOnly ? "Show All Products" : "Show In Stock Only";

	        // Reset and re-fetch products with the updated filter
	        currentPage = 1;
	        document.getElementById('product-grid').innerHTML = '';  // Clear existing products
	        loadMoreProducts();  // Load first page with filter applied
	    });
	});
</script>
{% endblock %}

